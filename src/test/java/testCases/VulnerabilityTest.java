package testCases;

import clientAPI.FactoryRequest;
import clientAPI.ResposeInfo;
import io.qameta.allure.*;
import org.json.JSONObject;


import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import utils.ConfigOWASP;

public class VulnerabilityTest{
    String idScanner;
    ResposeInfo resposeInfo;

    @DisplayName("Verificar el ecaneo de vulnerabilidad")
    @Description("esta es una descripcion .......")
    @Link("www.jira.com/TC999999sss")
    @Issue("BUG888888sss")
    @Test
    public void scanningVulnerabilityTest() throws InterruptedException {
        this.initScanner();
        this.checkProgressSanner();
    }

    @AfterEach
    public void generateReport(){
        // genero el reporte
        System.out.println("INFO> Scanner 100%");
        System.out.println("INFO> ***** generacion de reporte");
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.GENERATE_REPORT,"");
        System.out.println(resposeInfo.getBody());
        this.attachDocuments("Reporte OWASP",resposeInfo.getBody());
    }

    @Attachment(value="{0}",type = "text/html")
    public String attachDocuments(String name,String htmlReport){
        return htmlReport;
    }


    @Step("iniciando escaneo con OWASP ZAP")
    public void initScanner(){
        resposeInfo = new ResposeInfo();
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.START_SCANER+"https://todo.ly/","");
        this.idScanner= new JSONObject(resposeInfo.getBody()).getString("scan");
    }
    @Step("monitoreando a que llegue al 100%")
    public void checkProgressSanner() throws InterruptedException {
        //porcentage del escaneo 100%
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.PROGRESS_SCANER+idScanner,"");
        String percentage= new JSONObject(resposeInfo.getBody()).getString("status");
        while (!percentage.equals("2")){// 100
            Thread.sleep(15000);
            resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.PROGRESS_SCANER+idScanner,"");
            percentage= new JSONObject(resposeInfo.getBody()).getString("status");
            System.out.println("INFO> percentage: "+percentage+"%");
        }
    }

}


